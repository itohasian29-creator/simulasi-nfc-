<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SawitTrack NFC - Input Produksi</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <meta name="theme-color" content="#15803d">
    
    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        #debug-console { display: none; background: #333; color: #fff; padding: 10px; font-family: monospace; font-size: 10px; margin-top: 20px; border-radius: 5px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased">

    <div id="global-error" style="display:none; padding:20px; text-align:center; color:red;">
        <h3 style="font-weight:bold;">Terjadi Kesalahan</h3>
        <p id="error-msg">Aplikasi gagal dimuat.</p>
        <div id="debug-console"></div>
    </div>

    <div id="root">
        <div class="flex h-screen items-center justify-center flex-col gap-3">
            <div class="w-10 h-10 border-4 border-green-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-green-800 font-semibold animate-pulse">Memuat Aplikasi...</p>
            <p class="text-xs text-slate-400">Pastikan koneksi internet aktif</p>
        </div>
    </div>

    <script>
        // Global Error Handler untuk Mobile
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('global-error').style.display = 'block';
            document.getElementById('root').style.display = 'none';
            const consoleBox = document.getElementById('debug-console');
            consoleBox.style.display = 'block';
            consoleBox.innerHTML += `ERROR: ${message} at line ${lineno}<br/>`;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- DATA MASTER & ICONS (SAMA SEPERTI SEBELUMNYA) ---
        // (Saya ringkas bagian icon agar kode muat, fungsinya tetap sama)
        
        const DATA_KEMANDORAN = {
            "GENK/XX111-A": ["Andi Saputra", "Budi Hartono", "Rian Pratama", "Fajar Nugroho", "Dimas Setiawan"],
            "GENK/XX111-B": ["Eko Santoso", "Rudi Firmansyah", "Agung Purnomo", "Taufik Hidayat", "Bayu Saputra"]
        };
        const TPH_LIST = Array.from({length: 51}, (_, i) => "AA" + (100 + i));

        const IconBase = ({ d, children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {d ? <path d={d} /> : children}
            </svg>
        );
        // Icons Simplified for readability
        const Wifi = (p) => <IconBase {...p}><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></IconBase>;
        const Leaf = (p) => <IconBase {...p}><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></IconBase>;
        const Save = (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>;
        const Smartphone = (p) => <IconBase {...p}><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></IconBase>;
        const AlertCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>;
        const XIcon = (p) => <IconBase {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>;
        const Calculator = (p) => <IconBase {...p}><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconBase>;
        const Users = (p) => <IconBase {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>;
        const MapPin = (p) => <IconBase {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>;
        const ListIcon = (p) => <IconBase {...p}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></IconBase>;

        // --- MAIN APP ---
        const App = () => {
            const [isScanning, setIsScanning] = useState(false);
            const [nfcStatus, setNfcStatus] = useState({ supported: true, message: '' });
            const [logs, setLogs] = useState([]);
            const [currentTag, setCurrentTag] = useState(null);
            const [isSecure, setIsSecure] = useState(true);
            
            const [formData, setFormData] = useState({
                gank: '', worker: '', bucketCount: '', rbe: '', location: '', notes: ''
            });

            const totalWeight = useMemo(() => {
                const count = parseFloat(formData.bucketCount) || 0;
                const rbe = parseFloat(formData.rbe) || 0;
                return (count * rbe).toFixed(2);
            }, [formData.bucketCount, formData.rbe]);

            useEffect(() => {
                // Check Secure Context (HTTPS)
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                    setIsSecure(false);
                    setNfcStatus({ supported: false, message: 'Wajib HTTPS untuk NFC' });
                }

                const savedLogs = localStorage.getItem('brondolanLogs');
                if (savedLogs) setLogs(JSON.parse(savedLogs));

                if (!('NDEFReader' in window)) {
                    setNfcStatus({ supported: false, message: 'Browser tidak mendukung NFC' });
                }
            }, []);

            const startNfcScan = async () => {
                // Simulasi jika tidak support
                if (!nfcStatus.supported) {
                    simulateScan();
                    return;
                }

                try {
                    const ndef = new NDEFReader();
                    await ndef.scan();
                    setIsScanning(true);
                    
                    ndef.onreading = (event) => {
                        handleTagDetected(event.serialNumber);
                    };
                    
                    ndef.onreadingerror = () => {
                        alert("Gagal membaca tag. Coba lepas casing HP.");
                        setIsScanning(false);
                    };
                } catch (error) {
                    console.error(error);
                    // Fallback ke simulasi jika akses ditolak tapi user maksa ingin coba
                    if(confirm("NFC Error: " + error.message + "\n\nGunakan mode simulasi manual?")) {
                         simulateScan();
                    }
                    setIsScanning(false);
                }
            };

            const simulateScan = () => {
                setIsScanning(true);
                setTimeout(() => {
                    const mockSerial = "SIM-" + Math.floor(1000 + Math.random() * 9000);
                    handleTagDetected(mockSerial);
                }, 1000);
            };

            const handleTagDetected = (serialNumber) => {
                setIsScanning(false);
                setCurrentTag(serialNumber);
                const lastLog = logs[0];
                setFormData({ 
                    gank: lastLog ? lastLog.gank : '',
                    worker: '', bucketCount: '', 
                    rbe: lastLog ? lastLog.rbe : '', 
                    location: '', notes: '' 
                });
                if (navigator.vibrate) navigator.vibrate(200);
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => {
                    const newData = { ...prev, [name]: value };
                    if (name === 'gank') newData.worker = '';
                    return newData;
                });
            };

            const saveProductionData = () => {
                if (!formData.gank || !formData.worker || !formData.bucketCount || !formData.rbe || !formData.location) {
                    alert("Mohon lengkapi semua data!");
                    return;
                }
                const newEntry = {
                    id: Date.now(), tagId: currentTag, timestamp: new Date().toLocaleString('id-ID'),
                    ...formData, totalWeight: totalWeight
                };
                const updatedLogs = [newEntry, ...logs];
                setLogs(updatedLogs);
                localStorage.setItem('brondolanLogs', JSON.stringify(updatedLogs));
                setCurrentTag(null);
            };

            return (
                <div className="min-h-screen bg-slate-50 pb-20">
                    <header className="bg-green-700 text-white p-4 shadow-lg sticky top-0 z-10">
                        <div className="max-w-md mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <Leaf className="h-6 w-6 text-yellow-300" />
                                <h1 className="text-xl font-bold">SawitTrack</h1>
                            </div>
                            <div className="text-xs bg-green-800 px-2 py-1 rounded-full">v2.2 Mobile</div>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-4">
                        
                        {/* Peringatan HTTPS / Browser Support */}
                        {!isSecure && (
                            <div className="mb-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-3 rounded text-sm">
                                <b>Peringatan Keamanan!</b><br/>
                                Anda tidak menggunakan HTTPS. NFC tidak akan berfungsi. Gunakan mode simulasi.
                            </div>
                        )}
                        
                        {!nfcStatus.supported && isSecure && (
                             <div className="mb-4 bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-3 rounded text-sm">
                                <b>Mode Simulasi</b><br/>
                                {nfcStatus.message}. Input akan menggunakan ID simulasi.
                            </div>
                        )}

                        {/* Stats */}
                        <div className="grid grid-cols-2 gap-3 mb-6">
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                <p className="text-xs text-slate-500 font-semibold">TOTAL EMBER</p>
                                <p className="text-2xl font-bold text-green-700">{logs.reduce((a, b) => a + Number(b.bucketCount || 0), 0)}</p>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                <p className="text-xs text-slate-500 font-semibold">TOTAL KG</p>
                                <p className="text-2xl font-bold text-green-700">{logs.reduce((a, b) => a + Number(b.totalWeight || 0), 0).toLocaleString('id-ID')}</p>
                            </div>
                        </div>

                        {/* SCAN BUTTON */}
                        <div className="flex justify-center mb-8">
                            <button onClick={startNfcScan} disabled={isScanning}
                                className={`w-48 h-48 rounded-full flex flex-col items-center justify-center shadow-xl transition-all ${isScanning ? 'bg-orange-100 text-orange-600 animate-pulse border-4 border-orange-300' : 'bg-gradient-to-br from-green-500 to-green-700 text-white active:scale-95 border-4 border-green-300'}`}>
                                <Wifi className={`h-16 w-16 mb-2 ${isScanning ? 'animate-ping' : ''}`} />
                                <span className="font-bold text-xl">{isScanning ? 'MENCARI...' : 'SCAN NFC'}</span>
                            </button>
                        </div>

                        {/* History List */}
                        <div className="space-y-3">
                            <h2 className="font-bold text-lg flex items-center gap-2"><ListIcon className="h-5 w-5"/> Riwayat</h2>
                            {logs.length === 0 ? <p className="text-center text-slate-400 py-4">Belum ada data.</p> : 
                                logs.map(log => (
                                    <div key={log.id} className="bg-white p-4 rounded-lg shadow-sm border-l-4 border-green-500 flex justify-between">
                                        <div>
                                            <div className="text-xs font-bold text-green-800 mb-1">{log.gank.split('/')[1] || log.gank}</div>
                                            <div className="font-bold">{log.totalWeight} Kg <span className="font-normal text-xs text-slate-500">({log.bucketCount} ember)</span></div>
                                            <div className="text-sm">{log.worker}</div>
                                        </div>
                                        <button onClick={() => {if(confirm('Hapus?')){setLogs(logs.filter(l=>l.id!==log.id));localStorage.setItem('brondolanLogs',JSON.stringify(logs.filter(l=>l.id!==log.id)))}}} className="text-red-400"><Trash2/></button>
                                    </div>
                                ))
                            }
                        </div>
                    </main>

                    {/* MODAL INPUT (Sama seperti sebelumnya, disederhanakan) */}
                    {currentTag && (
                        <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
                            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between mb-4">
                                    <h3 className="text-xl font-bold">Input Data</h3>
                                    <button onClick={() => setCurrentTag(null)}><XIcon/></button>
                                </div>
                                <div className="space-y-4">
                                    <select name="gank" value={formData.gank} onChange={handleInputChange} className="w-full p-3 border rounded-lg bg-white">
                                        <option value="">Pilih Gank</option>
                                        {Object.keys(DATA_KEMANDORAN).map(k=><option key={k} value={k}>{k}</option>)}
                                    </select>
                                    <select name="worker" value={formData.worker} onChange={handleInputChange} className="w-full p-3 border rounded-lg bg-white" disabled={!formData.gank}>
                                        <option value="">Pilih Nama</option>
                                        {formData.gank && DATA_KEMANDORAN[formData.gank].map(n=><option key={n} value={n}>{n}</option>)}
                                    </select>
                                    <div className="grid grid-cols-2 gap-2">
                                        <input type="number" name="bucketCount" placeholder="Jml Ember" value={formData.bucketCount} onChange={handleInputChange} className="p-3 border rounded-lg text-center font-bold"/>
                                        <input type="number" name="rbe" placeholder="RBE (Kg)" value={formData.rbe} onChange={handleInputChange} className="p-3 border rounded-lg text-center font-bold"/>
                                    </div>
                                    <div className="text-center font-bold text-green-700 bg-green-50 p-2 rounded">Total: {totalWeight} Kg</div>
                                    <select name="location" value={formData.location} onChange={handleInputChange} className="w-full p-3 border rounded-lg bg-white">
                                        <option value="">Pilih TPH</option>
                                        {TPH_LIST.map(t=><option key={t} value={t}>{t}</option>)}
                                    </select>
                                    <button onClick={saveProductionData} className="w-full bg-green-700 text-white py-3 rounded-lg font-bold shadow-lg">SIMPAN</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>