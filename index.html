<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SawitTrack NFC - Input Produksi</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel untuk compile JSX di browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Meta untuk tampilan mobile app yang lebih baik -->
    <meta name="theme-color" content="#15803d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* Mencegah refresh pull-down di mobile */
        }
        /* Animasi Kustom */
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slide-up {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
        .animate-slide-up { animation: slide-up 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONS (Inline SVG components pengganti Lucide-React) ---
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Wifi = (props) => <IconBase {...props}><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></IconBase>;
        const Leaf = (props) => <IconBase {...props}><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const ListIcon = (props) => <IconBase {...props}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>;
        const Smartphone = (props) => <IconBase {...props}><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>;
        const XIcon = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>;

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [isScanning, setIsScanning] = useState(false);
            const [nfcSupported, setNfcSupported] = useState(true);
            const [logs, setLogs] = useState([]);
            const [currentTag, setCurrentTag] = useState(null);
            
            // Form State
            const [formData, setFormData] = useState({
                weight: '',
                location: '', 
                worker: '',   
                notes: ''
            });

            useEffect(() => {
                const savedLogs = localStorage.getItem('brondolanLogs');
                if (savedLogs) {
                    setLogs(JSON.parse(savedLogs));
                }

                if (!('NDEFReader' in window)) {
                    setNfcSupported(false);
                }
            }, []);

            const startNfcScan = async () => {
                if (!nfcSupported) {
                    simulateScan();
                    return;
                }

                try {
                    const ndef = new NDEFReader();
                    await ndef.scan();
                    setIsScanning(true);

                    ndef.onreading = (event) => {
                        const serialNumber = event.serialNumber;
                        handleTagDetected(serialNumber);
                    };

                    ndef.onreadingerror = () => {
                        alert("Gagal membaca tag NFC. Coba lagi.");
                        setIsScanning(false);
                    };

                } catch (error) {
                    console.log("Error: " + error);
                    alert("Pastikan NFC aktif dan izin browser diberikan.");
                    setIsScanning(false);
                }
            };

            const simulateScan = () => {
                setIsScanning(true);
                setTimeout(() => {
                    const mockSerial = "04:A3:5B:" + Math.floor(10 + Math.random() * 90);
                    handleTagDetected(mockSerial);
                }, 1500);
            };

            const handleTagDetected = (serialNumber) => {
                setIsScanning(false);
                setCurrentTag(serialNumber);
                // Get previous location/worker if available to speed up input
                const lastLog = logs[0];
                setFormData({ 
                    weight: '', 
                    location: lastLog ? lastLog.location : '', 
                    worker: lastLog ? lastLog.worker : '', 
                    notes: '' 
                });
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const saveProductionData = () => {
                if (!formData.weight || !formData.location) {
                    alert("Mohon isi Berat dan Lokasi TPH/Blok.");
                    return;
                }

                const newEntry = {
                    id: Date.now(),
                    tagId: currentTag,
                    timestamp: new Date().toLocaleString('id-ID'),
                    weight: formData.weight,
                    location: formData.location,
                    worker: formData.worker,
                    notes: formData.notes
                };

                const updatedLogs = [newEntry, ...logs];
                setLogs(updatedLogs);
                localStorage.setItem('brondolanLogs', JSON.stringify(updatedLogs));
                
                setCurrentTag(null);
                
                // Optional: Vibrate on save success
                if (navigator.vibrate) navigator.vibrate(200);
            };

            const deleteLog = (id) => {
                if(confirm("Hapus data ini?")) {
                    const updatedLogs = logs.filter(log => log.id !== id);
                    setLogs(updatedLogs);
                    localStorage.setItem('brondolanLogs', JSON.stringify(updatedLogs));
                }
            };

            const cancelScan = () => {
                setIsScanning(false);
                setCurrentTag(null);
            };

            return (
                <div className="min-h-screen bg-slate-50 pb-20">
                    {/* Header */}
                    <header className="bg-green-700 text-white p-4 shadow-lg sticky top-0 z-10">
                        <div className="max-w-md mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <Leaf className="h-6 w-6 text-yellow-300" />
                                <h1 className="text-xl font-bold tracking-tight">SawitTrack NFC</h1>
                            </div>
                            <div className="text-xs bg-green-800 px-2 py-1 rounded-full">
                                v1.0 Github
                            </div>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-4">
                        
                        {!nfcSupported && (
                            <div className="mb-4 bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-3 rounded text-sm flex items-start gap-2">
                                <AlertCircle className="h-5 w-5 mt-0.5 flex-shrink-0" />
                                <div>
                                    <p className="font-bold">Browser tidak support Web NFC</p>
                                    <p>Menggunakan mode simulasi. Gunakan Chrome di Android untuk scan asli.</p>
                                </div>
                            </div>
                        )}

                        {/* Dashboard Cards */}
                        <div className="grid grid-cols-2 gap-3 mb-6">
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                <p className="text-xs text-slate-500 uppercase font-semibold">Total Input</p>
                                <p className="text-2xl font-bold text-green-700">{logs.length}</p>
                                <p className="text-xs text-slate-400">Hari ini</p>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                <p className="text-xs text-slate-500 uppercase font-semibold">Total Berat</p>
                                <p className="text-2xl font-bold text-green-700">
                                    {logs.reduce((acc, curr) => acc + Number(curr.weight || 0), 0)} <span className="text-sm font-normal text-slate-500">kg</span>
                                </p>
                                <p className="text-xs text-slate-400">Akumulasi</p>
                            </div>
                        </div>

                        {/* Action Button */}
                        <div className="flex justify-center mb-8">
                            <button 
                                onClick={startNfcScan}
                                disabled={isScanning}
                                className={`
                                    relative w-48 h-48 rounded-full flex flex-col items-center justify-center shadow-xl transition-all
                                    ${isScanning 
                                        ? 'bg-orange-100 text-orange-600 animate-pulse border-4 border-orange-300' 
                                        : 'bg-gradient-to-br from-green-500 to-green-700 text-white hover:scale-105 border-4 border-green-300 active:scale-95'
                                    }
                                `}
                            >
                                {isScanning ? (
                                    <React.Fragment>
                                        <Wifi className="h-16 w-16 mb-2 animate-ping" />
                                        <span className="font-semibold text-lg">Mencari Tag...</span>
                                        <span className="text-xs mt-1">Tempelkan ke HP</span>
                                    </React.Fragment>
                                ) : (
                                    <React.Fragment>
                                        <Wifi className="h-16 w-16 mb-2" />
                                        <span className="font-bold text-xl">SCAN NFC</span>
                                        <span className="text-xs opacity-80 mt-1">Tap untuk Input</span>
                                    </React.Fragment>
                                )}
                            </button>
                        </div>

                        {/* Recent Logs List */}
                        <div className="mb-4 flex items-center justify-between">
                            <h2 className="font-bold text-lg flex items-center gap-2">
                                <ListIcon className="h-5 w-5 text-slate-500" />
                                Riwayat Input
                            </h2>
                            <span className="text-xs text-slate-500">Terbaru di atas</span>
                        </div>

                        <div className="space-y-3 pb-10">
                            {logs.length === 0 ? (
                                <div className="text-center py-8 text-slate-400 bg-white rounded-lg border border-dashed border-slate-300">
                                    <Smartphone className="h-8 w-8 mx-auto mb-2 opacity-50" />
                                    <p>Belum ada data brondolan.</p>
                                </div>
                            ) : (
                                logs.map((log) => (
                                    <div key={log.id} className="bg-white p-4 rounded-lg shadow-sm border-l-4 border-green-500 flex justify-between items-start animate-fade-in">
                                        <div>
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="bg-green-100 text-green-800 text-xs px-2 py-0.5 rounded font-mono font-bold">
                                                    {log.location}
                                                </span>
                                                <span className="text-xs text-slate-400">{log.timestamp}</span>
                                            </div>
                                            <div className="font-bold text-slate-800 text-lg">
                                                {log.weight} kg <span className="text-sm font-normal text-slate-500">Brondolan</span>
                                            </div>
                                            <div className="text-sm text-slate-600">
                                                Oleh: {log.worker} <span className="text-xs text-slate-400">({log.tagId})</span>
                                            </div>
                                        </div>
                                        <button 
                                            onClick={() => deleteLog(log.id)}
                                            className="text-red-400 hover:text-red-600 p-2"
                                        >
                                            <Trash2 className="h-5 w-5" />
                                        </button>
                                    </div>
                                ))
                            )}
                        </div>
                    </main>

                    {/* Input Modal / Sheet */}
                    {currentTag && (
                        <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
                            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl animate-slide-up">
                                <div className="flex justify-between items-center mb-6">
                                    <div>
                                        <h3 className="text-xl font-bold text-slate-800">Input Data Produksi</h3>
                                        <p className="text-sm text-green-600 font-mono mt-1 flex items-center gap-1">
                                            <Wifi className="h-3 w-3" /> ID Tag: {currentTag}
                                        </p>
                                    </div>
                                    <button onClick={cancelScan} className="bg-slate-100 p-2 rounded-full hover:bg-slate-200">
                                        <XIcon className="h-5 w-5 text-slate-600" />
                                    </button>
                                </div>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Berat Brondolan (Kg)</label>
                                        <div className="relative">
                                            <input
                                                type="number"
                                                name="weight"
                                                value={formData.weight}
                                                onChange={handleInputChange}
                                                placeholder="0"
                                                className="w-full p-3 pl-4 pr-12 text-lg border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none"
                                                autoFocus
                                            />
                                            <span className="absolute right-4 top-3.5 text-slate-400 font-bold">KG</span>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">Lokasi (TPH/Blok)</label>
                                            <input
                                                type="text"
                                                name="location"
                                                value={formData.location}
                                                onChange={handleInputChange}
                                                placeholder="Cth: A12"
                                                className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">Nama Pemuat</label>
                                            <input
                                                type="text"
                                                name="worker"
                                                value={formData.worker}
                                                onChange={handleInputChange}
                                                placeholder="Nama"
                                                className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
                                            />
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Catatan (Opsional)</label>
                                        <textarea
                                            name="notes"
                                            value={formData.notes}
                                            onChange={handleInputChange}
                                            rows="2"
                                            placeholder="Kualitas buah, dsb..."
                                            className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
                                        ></textarea>
                                    </div>

                                    <button
                                        onClick={saveProductionData}
                                        className="w-full bg-green-700 text-white py-4 rounded-xl font-bold text-lg hover:bg-green-800 transition-colors flex items-center justify-center gap-2 mt-2 shadow-lg shadow-green-700/30 active:scale-95"
                                    >
                                        <Save className="h-5 w-5" />
                                        SIMPAN DATA
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>